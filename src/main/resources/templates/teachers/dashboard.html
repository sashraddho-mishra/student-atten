<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Teacher Dashboard - Student Attendance</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
<div class="container">
    <h1>Teacher Dashboard</h1>
    
    <div class="subject-selector">
        <label>Select Course/Subject</label>
        <form method="get" th:action="@{/teacher/dashboard}">
            <select name="subjectId">
                <option value="">-- Select a subject --</option>
                <option th:each="sub : ${subjects}" th:value="${sub.id}" th:text="${sub.name}"
                        th:selected="${selectedSubjectId != null} ? ${sub.id} == ${selectedSubjectId} : false"></option>
            </select>
            <button type="submit">Select</button>
        </form>
    </div>

    <div th:if="${selectedSubjectId != null}" class="attendance-form">
        <form th:action="@{/teacher/attendance/mark-bulk}" method="post" id="attendanceForm">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div class="date-selector">
                <label>Date</label>
                <input type="date" name="date" th:value="${date}" required />
            </div>
            <div>
                <input type="hidden" name="subjectId" th:value="${selectedSubjectId}" />
            </div>
            <table>
                <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Roll Number</th>
                    <th>Present</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${students == null or students.isEmpty()}">
                    <td colspan="5" style="text-align: center; color: #718096; padding: 40px;">
                        No students found. Add students to this course first.
                    </td>
                </tr>
                <tr th:each="s,iterStat : ${students}">
                    <td th:text="${iterStat.index + 1}"></td>
                    <td th:text="${s.name}"></td>
                    <td th:text="${s.rollNumber}"></td>
                    <td>
                        <input type="checkbox" name="presentIds" th:value="${s.id}" th:checked="${s.present}" />
                    </td>
                    <td>
                        <button type="button" class="delete-btn" th:attr="data-id=${s.id}" th:data-subject-id="${selectedSubjectId}">Delete</button>
                    </td>
                </tr>
                </tbody>
            </table>
            <div class="form-actions" th:if="${students != null and !students.isEmpty()}">
                <button type="submit">Save Attendance</button>
            </div>
        </form>
    </div>

    <div class="nav">
        <a th:href="@{|/teacher/students/add?course=${course}|}">Add Student</a>
        <a th:href="@{/teacher/students}">View All Students</a>
        <a th:href="@{/teacher/attendance/report}">Attendance Report</a>
        <form th:action="@{/logout}" method="post" style="display: inline;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" style="background: linear-gradient(135deg, #718096 0%, #4a5568 100%);">Logout</button>
        </form>
    </div>
</div>

<script th:inline="javascript">
/*<![CDATA[*/
    (function() {
        // Get CSRF token from meta tag or inline variable
        const csrfToken = /*[[${_csrf.token}]]*/ '';
        const csrfHeaderName = /*[[${_csrf.headerName}]]*/ 'X-CSRF-TOKEN';
        const csrfParameterName = /*[[${_csrf.parameterName}]]*/ '_csrf';
        const selectedSubjectId = /*[[${selectedSubjectId}]]*/ null;

        document.querySelectorAll('.delete-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const studentId = this.getAttribute('data-id');
                const subjectId = this.getAttribute('data-subject-id') || selectedSubjectId;
                
                if (!confirm('Are you sure you want to delete this student?')) {
                    return false;
                }
                
                // Create a form dynamically to submit the delete request
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/teacher/students/delete/' + studentId;
                
                // Add CSRF token
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = csrfParameterName;
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);
                
                // Add subjectId if it exists
                if (subjectId) {
                    const subjectInput = document.createElement('input');
                    subjectInput.type = 'hidden';
                    subjectInput.name = 'subjectId';
                    subjectInput.value = subjectId;
                    form.appendChild(subjectInput);
                }
                
                // Append to body and submit
                document.body.appendChild(form);
                form.submit();
            });
        });
    })();
/*]]>*/
</script>
</body>
</html>
